%% this script will calculate supply LOS for the TBW System in four ways
% 1) LOS Reliability: fraction of days that meet demand
% 2) LOS Vulnerability: number of failure periods
% 3) Failure duration: 95th percentile length of failure period each year
% 4) Failure magnitude: 95th percentile exceedance of criteria each year

%% load slack variables
% this loads scenarios 125 141-144
load("yield_slacks.mat")


%% Calculate days with at least one failure at any source
% output: all_failures a binary matrix 1000 rel by 7305 days, 
% values of 1 indicate a days with at least one non-zero slack variable,
% 0 indicate demand met

% make sure to select the proper scenario, 125 is here for an example
all_failures = zeros(1000, 7305);
for i=1:1000
    cur_rel = slacks_143{i};
    for j=1:7305
        if cur_rel.Alafia(j) > 0 || cur_rel.TBC(j) > 0 ...
                || cur_rel.Reservoir(j) > 0 || cur_rel.SCH(j) > 0 ...
                || cur_rel.SCH3(j) > 0 || cur_rel.BUD(j) > 0 ...
                || cur_rel.CWUP(j) > 0
            all_failures(i,j) = 1;
        end
    end
end
%% count the number of 30 day periods 
% 60 days consec failure will be counted as two 30 day periods here
% output: num_30fail_periods, the number of 30 day failures in each year
% of each rel

num_30fail_periods = zeros(1000,20);

for i=1:1000
    year=1;
    for day = 1:365:6936
        fail_count = 0;
        for k=0:364
            if all_failures(i, day+k) > 0
                fail_count = fail_count + 1;
                if fail_count > 29
                    num_30fail_periods(i,year) = num_30fail_periods(i,year)+1;
                    fail_count = 0;
                end
            else
                fail_count = 0;
            end
        end
        
     year = year+1;
    end
end
%% calculate reliability: the number of relizations with 30 day failures
fail_30_reliabilty = zeros(20,1);
for j=1:20
    fail_30_reliabilty(j) = length(find(num_30fail_periods(:,j)))/1000;
end
csvwrite('reliability_30_day_run141.csv',fail_30_reliabilty);

%% Calculate  percentiles of failures per year (for vulnerability calc)
% get the quanitles of num_30fail_periods
fail30_period_percentiles = zeros(100,20);
for j=1:20
    fail30_period_percentiles(:,j) = ...
        prctile(num_30fail_periods(:,j),(1:100));
end

csvwrite('failure_duration_quantiles_30_day_run141.csv',fail30_period_percentiles);
