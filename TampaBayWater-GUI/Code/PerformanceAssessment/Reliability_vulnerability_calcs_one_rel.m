%% this script will calculate supply LOS for the TBW System in four ways
% 1) LOS Reliability: fraction of days that meet demand
% 2) LOS Vulnerability: number of failure periods
% 3) Failure duration: 95th percentile length of failure period each year
% 4) Failure magnitude: 95th percentile exceedance of criteria each year

%% load slack variables
% this loads scenarios 125 141-144
load("yield_slacks.mat")


%% Calculate days with at least one failure at any source
% output: all_failures a binary matrix 1000 rel by 7305 days, 
% values of 1 indicate a days with at least one non-zero slack variable,
% 0 indicate demand met

scenario = 143;
realization = 612;

% make sure to select the proper scenario, 125 is here for an example
all_failures = zeros(7305,1);
%for i=1:1000
if scenario == 143
    cur_rel = slacks_143{realization};
else
    cur_rel = slacks_141{realization};
end
for j=1:7305
    if cur_rel.Alafia(j) > 0 || cur_rel.TBC(j) > 0 ...
            || cur_rel.Reservoir(j) > 0 || cur_rel.BUD(j) > 0 ...
            || cur_rel.CWUP(j) > 0
        all_failures(j) = 1;
    end
end
%end
% count the number of 30 day periods 
% 60 days consec failure will be counted as two 30 day periods here
% output: num_30fail_periods, the number of 30 day failures in each year


num_30fail_periods = zeros(20,1);

year=1;
for day = 1:365:6936
    fail_count = 0;
    for k=0:364
        if all_failures(day+k) > 0
            fail_count = fail_count + 1;
            if fail_count > 29
                num_30fail_periods(year) = num_30fail_periods(year)+1;
                fail_count = 0;
            end
        else
            fail_count = 0;
        end
    end

 year = year+1;
end

csvwrite(strcat('failure_duration_real_', num2str(realization),'_noSCH_', num2str(scenario),'.csv'),num_30fail_periods);
% sum magnitude of slacks
%%
all_slack = cur_rel.Alafia + cur_rel.TBC + cur_rel.CWUP + ...
    cur_rel.Reservoir + cur_rel.BUD + cur_rel.SCH + cur_rel.SCH3;

rolling_mean = zeros(7305-30,1);
for day = 1:365:6936
    for k=0:364
        if day + k + 30 < 7305
            rolling_mean(day+k) = mean(all_slack(day+k:day+k+30));
        end
    end
end
%%

hold on
plot(1:7275, rolling_mean)
